<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Murugan Laundry Bill</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #000; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    input { width: 100%; border: none; outline: none; }
    .small-input { width: 60px; }
    .actions button { background: red; color: #fff; border: none; padding: 4px 8px; cursor: pointer; }
    @media print {
      .no-print { display: none; }
      td:nth-child(7), th:nth-child(7) { display: none; }
    }
  </style>
</head>
<body>
<div id="invoice">

  <h2 style="text-align:center;">Murugan Laundry Bill</h2>

  <label>Order ID: <input type="text" id="orderId"></label><br><br>

  <table id="itemsTable">
    <thead>
      <tr>
        <th>Sl. No.</th>
        <th>Description</th>
        <th>Service</th>
        <th>Price</th>
        <th>Qty</th>
        <th>Amount</th>
        <th class="no-print">Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Initial 10 rows -->
      <tr>
        <td>1</td>
        <td><input type="text" class="desc-input"></td>
        <td><input type="text"></td>
        <td><input type="number" class="small-input price" oninput="calculateRow(this)"></td>
        <td><input type="number" class="small-input qty" oninput="calculateRow(this)"></td>
        <td><span class="amount">0.00</span></td>
        <td class="no-print actions"><button onclick="deleteRow(this)">X</button></td>
      </tr>
      <tr>
        <td>2</td>
        <td><input type="text" class="desc-input"></td>
        <td><input type="text"></td>
        <td><input type="number" class="small-input price" oninput="calculateRow(this)"></td>
        <td><input type="number" class="small-input qty" oninput="calculateRow(this)"></td>
        <td><span class="amount">0.00</span></td>
        <td class="no-print actions"><button onclick="deleteRow(this)">X</button></td>
      </tr>
      <!-- repeat until row 10 -->
      <tr>
        <td>10</td>
        <td><input type="text" class="desc-input"></td>
        <td><input type="text"></td>
        <td><input type="number" class="small-input price" oninput="calculateRow(this)"></td>
        <td><input type="number" class="small-input qty" oninput="calculateRow(this)"></td>
        <td><span class="amount">0.00</span></td>
        <td class="no-print actions"><button onclick="deleteRow(this)">X</button></td>
      </tr>
    </tbody>
  </table>

  <h3>Total: â‚¹<span id="grandTotal">0.00</span></h3>
</div>

<!-- Buttons -->
<div class="no-print">
  <button onclick="saveAsPDF()">Save as PDF</button>
  <button onclick="printBill()">Print</button>
</div>

<script>
/* === Calculate Row === */
function calculateRow(el){
  const row = el.closest("tr");
  const price = parseFloat(row.querySelector(".price").value) || 0;
  const qty = parseFloat(row.querySelector(".qty").value) || 0;
  const amt = price * qty;
  row.querySelector(".amount").innerText = amt.toFixed(2);
  calculateTotal();
  addRowIfNeeded();
}

/* === Calculate Grand Total === */
function calculateTotal(){
  let total = 0;
  document.querySelectorAll(".amount").forEach(a => total += parseFloat(a.innerText) || 0);
  document.getElementById("grandTotal").innerText = total.toFixed(2);
}

/* === Add Row if Last Filled === */
function addRowIfNeeded(){
  const rows = document.querySelectorAll("#itemsTable tbody tr");
  const lastRow = rows[rows.length-1];
  const desc = lastRow.querySelector(".desc-input").value.trim();
  const qty = lastRow.querySelector(".qty").value.trim();

  if(desc !== "" && qty !== ""){
    addNewRow();
  }
}

/* === Add New Row === */
function addNewRow(){
  const tbody = document.querySelector("#itemsTable tbody");
  const newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td></td>
    <td><input type="text" class="desc-input"></td>
    <td><input type="text"></td>
    <td><input type="number" class="small-input price" oninput="calculateRow(this)"></td>
    <td><input type="number" class="small-input qty" oninput="calculateRow(this)"></td>
    <td><span class="amount">0.00</span></td>
    <td class="no-print actions"><button onclick="deleteRow(this)">X</button></td>
  `;
  tbody.appendChild(newRow);
  updateSerialNumbers();
}

/* === Delete Row === */
function deleteRow(btn){
  const row = btn.closest("tr");
  row.remove();
  updateSerialNumbers();
  calculateTotal();
}

/* === Update Serial Numbers === */
function updateSerialNumbers(){
  document.querySelectorAll("#itemsTable tbody tr").forEach((row,i)=>{
    row.querySelector("td:first-child").innerText = i+1;
  });
}

/* === Save as PDF === */
function saveAsPDF(){
  const orderId = document.getElementById("orderId").value || "NoID";
  const fileName = `Murugan Laundry Bill - ${orderId}.pdf`;

  // Hide Action col
  document.querySelectorAll("#itemsTable td:nth-child(7), #itemsTable th:nth-child(7)").forEach(el=>el.style.display="none");

  const invoice = document.getElementById("invoice");
  html2pdf().set({
    margin: 10,
    filename: fileName,
    image: { type: 'jpeg', quality: 1 },
    html2canvas: { scale: 3, scrollY: 0, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).from(invoice).save().then(()=>{
    // Restore
    document.querySelectorAll("#itemsTable td:nth-child(7), #itemsTable th:nth-child(7)").forEach(el=>el.style.display="");
  });
}

/* === Print Bill === */
function printBill(){
  document.querySelectorAll("#itemsTable td:nth-child(7), #itemsTable th:nth-child(7)").forEach(el=>el.style.display="none");
  window.print();
  document.querySelectorAll("#itemsTable td:nth-child(7), #itemsTable th:nth-child(7)").forEach(el=>el.style.display="");
}
</script>
</body>
</html>
